#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bash

prompt_yn () {
    MSG=${1:-'Proceed?'}
    read -p "$MSG [y/N] " -n 1 -r
    echo ""
    if ! [[ $REPLY =~ ^[Yy]$ ]]; then return 1; fi
}
unlink_res() {
  if [ -L ./result ]; then
    echo "Build is in:"
    readlink result
    unlink result
  fi
}

if [ "$EUID" -ne 0 ]; then
  echo 'Must be run as SUDO'
  exit 5
fi

# Move to the nix-system-cfg-directory
if [ -z ${DOTFILES+x} ]; then
  echo 'Variable $DOTFILES must be set to run this script'
  echo 'Run sudo -E to keep user environment'
  exit 4
fi
cd $DOTFILES/nix/

# Remove config-path
NIX_PATH="$(echo $NIX_PATH | sed 's/:nixos-config=[^:]*//')"
# Add new config-path
NIX_PATH="$NIX_PATH:nixos-config=$(pwd)/src/configuration.nix"

# Add system packages such as `nixos-rebuild`
PATH="$PATH:/run/current-system/sw/bin"

# Confirm with the user
if ! prompt_yn 'Build changes?'; then exit 3; fi

echo "------------------------------"
echo "-- Building config -----------"
echo "------------------------------"

if nixos-rebuild build
then
  if prompt_yn 'Activate build?'
  then
    # Safe to switch
    echo "------------------------------"
    echo "-- Activating config ---------"
    echo "------------------------------"
    result/activate
  fi

  if prompt_yn 'Switch build?'
  then
    # Safe to switch
    echo "------------------------------"
    echo "-- Switching config ----------"
    echo "------------------------------"
    nixos-rebuild boot
  fi
fi

if [ ! -L result ]
then
  # The compilation must have failed
  exit 2
fi

unlink_res

